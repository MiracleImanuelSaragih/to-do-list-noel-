<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium To-Do List - Miracle</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
/* ... CSS kamu tetap sama ... */
</style>
</head>

<body>
<audio id="alarmSound">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
</audio>

<div class="container">
  <div class="header">
    <h2>ğŸš€ Premium To-Do List</h2>
    <div>
      <button class="icon-btn" onclick="toggleDark()">ğŸŒ™</button>
      <button class="icon-btn" onclick="requestNotif()">ğŸ””</button>
    </div>
  </div>

  <div id="countdown"></div>

  <div class="main-card">

    <div class="input-row">
      <input id="taskText" placeholder="Tugas...">
      <select id="taskPriority">
        <option value="low">ğŸŸ¢ Low</option>
        <option value="medium">ğŸŸ¡ Medium</option>
        <option value="high">ğŸ”´ High</option>
      </select>
      <select id="taskReminder">
        <option value="0">No Reminder</option>
        <option value="5">5 menit</option>
        <option value="15" selected>15 menit</option>
        <option value="30">30 menit</option>
      </select>
      <button class="btn" onclick="addTask()">Tambah</button>
    </div>

    <input type="datetime-local" id="taskTime">

    <div id="taskList"></div>
  </div>
</div>

<script>
// ğŸ”¹ Inisialisasi Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAcnTpDBXO2WpXs3ri21SXJfzUMC_xkCkU",
  authDomain: "premium-todo-list.firebaseapp.com",
  projectId: "premium-todo-list",
  storageBucket: "premium-todo-list.appspot.com",
  messagingSenderId: "630693485104",
  appId: "1:630693485104:web:820a99e6af935a7345abf5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let alarmTimer;

function toggleDark(){
  document.body.classList.toggle("dark-mode");
}

function playSound(){
  const s=document.getElementById("alarmSound");
  s.currentTime=0;
  s.play().catch(()=>{});
}

function requestNotif(){
  if("Notification"in window){
    Notification.requestPermission();
  }
}

function notify(title,body){
  if(Notification.permission==="granted"){
    new Notification(title,{body});
  }
}

// ğŸ”¹ Tambah task ke Firestore
function addTask(){
  const text=taskText.value.trim();
  const time=taskTime.value;
  if(!text||!time)return alert("Lengkapi data");

  db.collection("tasks").add({
    text,
    time,
    priority:taskPriority.value,
    reminder:+taskReminder.value,
    completed:false,
    reminded:false,
    alarmed:false,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  taskText.value="";
  taskTime.value="";
}

// ğŸ”¹ Toggle status selesai
function toggleTask(id, current){
  db.collection("tasks").doc(id).update({
    completed: !current
  });
}

// ğŸ”¹ Hapus task
function delTask(id){
  if(confirm("Hapus tugas?")){
    db.collection("tasks").doc(id).delete();
  }
}

// ğŸ”¹ Render real-time dari Firestore
db.collection("tasks").orderBy("timestamp","desc").onSnapshot(snapshot=>{
  const list=document.getElementById("taskList");
  list.innerHTML="";
  const now=new Date();

  snapshot.forEach(doc=>{
    const t=doc.data();
    const dt=new Date(t.time);
    const div=document.createElement("div");
    div.className="task";
    if(t.completed)div.classList.add("completed");
    if(dt<now&&!t.completed)div.classList.add("overdue");
    if(dt-now<3600000&&dt>now)div.classList.add("upcoming");

    div.innerHTML=`
      <input type="checkbox" ${t.completed?"checked":""} onchange="toggleTask('${doc.id}', ${t.completed})">
      <div>
        <b>${t.text}</b><br>
        â° ${dt.toLocaleString()} | ${t.priority.toUpperCase()}
      </div>
      <div class="actions">
        <button onclick="delTask('${doc.id}')">ğŸ—‘ï¸</button>
      </div>`;
    list.appendChild(div);
  });

  updateCountdown(snapshot.docs.map(d=>d.data()));
});

function updateCountdown(tasks){
  const box=document.getElementById("countdown");
  const now=new Date();
  const upcoming=tasks
    .filter(t=>!t.completed)
    .map(t=>new Date(t.time))
    .filter(d=>d>now)
    .sort((a,b)=>a-b)[0];

  if(!upcoming){box.innerHTML="";return;}

  const diff=upcoming-now;
  box.innerHTML=`â³ Jadwal terdekat dalam ${Math.floor(diff/60000)} menit`;
}

function startAlarm(){
  alarmTimer=setInterval(async ()=>{
    const now=new Date();
    const snapshot=await db.collection("tasks").get();
    snapshot.forEach(doc=>{
      const t=doc.data();
      if(t.completed)return;
      const dt=new Date(t.time);
      const rem=new Date(dt.getTime()-t.reminder*60000);

      if(!t.reminded && t.reminder>0 && now>=rem && now<dt){
        notify("â° Reminder",`${t.text}`);
        playSound();
        db.collection("tasks").doc(doc.id).update({reminded:true});
      }

      if(!t.alarmed && now>=dt && now-dt<60000){
        notify("ğŸš¨ Alarm",`${t.text}`);
        playSound();
        db.collection("tasks").doc(doc.id).update({alarmed:true});
      }
    });
  },10000);
}

startAlarm();
</script>
</body>
</html>
